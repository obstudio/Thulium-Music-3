postfix: .thulium
default: undef

tokenizer:
  root: 
    - include: comment # 注释
    - include: command # 命令
    - include: track   # 音轨

  comment:
    - regex: ^//
      action:
        cases:
          '@eos':
            token: comment.marker
          '@default':
            token: comment.marker
            next: comment.line

  comment.line:
    # 分割线中央的字段被认为是乐章名
    - regex: -{3,}.*[^-]-{3,}$
      action:
        token: '@rematch'
        switchTo: comment.section
    # 普通的注释内容
    - - .*$
      - comment.default
      - '@pop'

  comment.section:
    - regex: -{3,}
      action:
        cases:
          '@eos': 
            token: comment.marker
            next: '@pop'
          '@default':
            token: comment.marker
    - - .*[^-]
      - section.name

  command:
    - - ^# *
      - command.marker
      - command.general

  command.general:
    - regex: (?i)end *$
      action:
        token: command.keyword
        next: '@pop'
    - regex: (?i)include *
      action:
        token: command.keyword
        switchTo: library.include
    - regex: (?i)(function|notation) *
      action: 
        token: command.keyword
        switchTo: library.code
        nextEmbedded: text/javascript

  library.include:
    - - '[a-zA-Z]\w* *$'
      - library.package
      - '@pop'

  library.code:
    - regex: ^#
      action: 
        token: '@rematch'
        next: '@pop'
        nextEmbedded: '@pop'

  track:
    - regex: <:?(?=[a-zA-Z\s])
      action:
        token: track.marker
        next: track.head

  track.head:
    - - :?>
      - track.marker
      - '@pop'
    - - '[a-zA-Z]\w*:'
      - '@rematch'
      - track.name
    - - ','
      - track.marker
    - - '[a-zA-Z]\w*'
      - track.instrument
      - track.instrument

  track.name:
    - - ':'
      - track.marker
      - '@pop'
    - - \w+
      - track.name

  track.instrument:
    - - '[,>]'
      - '@rematch'
      - '@pop'
